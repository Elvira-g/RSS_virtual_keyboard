const keys = [
    {
        "id": 1,
        "key": "Backquote",
        "rusName": "]",
        "rusShift": "[",
        "rusCaps": "[",
        "engName": "`",
        "engShift": "~",
        "engCaps": "~"
    },
    {
        "id": 2,
        "key": "1",
        "rusName": "1",
        "rusShift": "!",
        "rusCaps": "!",
        "engName": "1",
        "engShift": "!",
        "engCaps": "!"
    },
    {
        "id": 3,
        "key": "Digit2",
        "rusName": "2",
        "rusShift": "\"",
        "rusCaps": "\"",
        "engName": "2",
        "engShift": "@",
        "engCaps": "@"
    },
    {
        "id": 4,
        "key": "Digit3",
        "rusName": "3",
        "rusShift": "№",
        "rusCaps": "№",
        "engName": "3",
        "engShift": "#",
        "engCaps": "#"
    },
    {
        "id": 5,
        "rusName": "4",
        "key": "Digit4",
        "rusShift": "%",
        "rusCaps": "%",
        "engName": "4",
        "engShift": "$",
        "engCaps": "$"
    },
    {
        "id": 6,
        "rusName": "5",
        "key": "Digit5",
        "rusShift": ":",
        "rusCaps": ":",
        "engName": "5",
        "engShift": "%",
        "engCaps": "%"
    },
    {
        "id": 7,
        "key": "Digit6",
        "rusName": "6",
        "rusShift": ",",
        "rusCaps": ",",
        "engName": "6",
        "engShift": "^",
        "engCaps": "^"
    },
    {
        "id": 8,
        "key": "Digit7",
        "rusName": "7",
        "rusShift": ".",
        "rusCaps": ".",
        "engName": "7",
        "engShift": "&",
        "engCaps": "&"
    },
    {
        "id": 9,
        "key": "Digit8",
        "rusName": "8",
        "rusShift": ";",
        "rusCaps": ";",
        "engName": "8",
        "engShift": "*",
        "engCaps": "*"
    },
    {
        "id": 10,
        "key": "Digit9",
        "rusName": "9",
        "rusShift": "(",
        "rusCaps": "(",
        "engName": "9",
        "engShift": "(",
        "engCaps": "("
    },
    {
        "id": 11,
        "key": "Digit0",
        "rusName": "0",
        "rusShift": ")",
        "rusCaps": ")",
        "engName": "0",
        "engShift": ")",
        "engCaps": ")"
    },
    {
        "id": 12,
        "key": "Minus",
        "rusName": "-",
        "rusShift": "_",
        "rusCaps": "_",
        "engName": "-",
        "engShift": "_",
        "engCaps": "_"
    },
    {
        "id": 13,
        "key": "Equal",
        "rusName": "=",
        "rusShift": "+",
        "rusCaps": "+",
        "engName": "=",
        "engShift": "+",
        "engCaps": "+"
    },
    {
        "id": 14,
        "key": "Backspace",
        "rusName": "<-",
        "rusShift": "<-",
        "rusCaps": "<-",
        "engName": "<-",
        "engShift": "<-",
        "engCaps": "<-"
    },
    {
        "id": 15,
        "key": "Tab",
        "rusName": "Tab",
        "rusShift": "Tab",
        "rusCaps": "Tab",
        "engName": "Tab",
        "engShift": "Tab",
        "engCaps": "Tab"
    },
    {
        "id": 16,
        "code": "q",
        "key": "KeyQ",
        "rusName": "й",
        "rusShift": "Й",
        "rusCaps": "Й",
        "engName": "q",
        "engShift": "Q",
        "engCaps": "Q"
    },
    {
        "id": 17,
        "key": "KeyW",
        "rusName": "ц",
        "rusShift": "Ц",
        "rusCaps": "Ц",
        "engName": "w",
        "engShift": "W",
        "engCaps": "W"
    },
    {
        "id": 18,
        "key": "KeyE",
        "rusName": "у",
        "rusShift": "У",
        "rusCaps": "У",
        "engName": "e",
        "engShift": "E",
        "engCaps": "E"
    },
    {
        "id": 19,
        "key": "KeyR",
        "rusName": "к",
        "rusShift": "К",
        "rusCaps": "К",
        "engName": "r",
        "engShift": "R",
        "engCaps": "R"
    },
    {
        "id": 20,
        "key": "KeyT",
        "rusName": "е",
        "rusShift": "Е",
        "rusCaps": "Е",
        "engName": "t",
        "engShift": "T",
        "engCaps": "T"
    },
    {
        "id": 21,
        "key": "KeyY",
        "rusName": "н",
        "rusShift": "Н",
        "rusCaps": "Н",
        "engName": "y",
        "engShift": "Y",
        "engCaps": "Y"
    },
    {
        "id": 22,
        "key": "KeyU",
        "rusName": "г",
        "rusShift": "Г",
        "rusCaps": "Г",
        "engName": "u",
        "engShift": "U",
        "engCaps": "U"
    },
    {
        "id": 23,
        "key": "KeyI",
        "rusName": "ш",
        "rusShift": "Ш",
        "rusCaps": "Ш",
        "engName": "i",
        "engShift": "I",
        "engCaps": "I"
    },
    {
        "id": 24,
        "key": "KeyP",
        "rusName": "з",
        "rusShift": "З",
        "rusCaps": "З",
        "engName": "p",
        "engShift": "P",
        "engCaps": "P"
    },
    {
        "id": 25,
        "key": "BracketLeft",
        "rusName": "х",
        "rusShift": "Х",
        "rusCaps": "Х",
        "engName": "[",
        "engShift": "{",
        "engCaps": "{"
    },
    {
        "id": 26,
        "key": "BracketRight",
        "rusName": "ъ",
        "rusShift": "Ъ",
        "rusCaps": "Ъ",
        "engName": "]",
        "engShift": "}",
        "engCaps": "}"
    },
    {
        "id": 27,
        "key": "Backslash",
        "rusName": "Del",
        "rusShift": "Del",
        "rusCaps": "Del",
        "engName": "Del",
        "engShift": "Del",
        "engCaps": "Del"
    },
    {
        "id": 28,
        "key": "CapsLock",
        "rusName": "CapsLock",
        "rusShift": "CapsLock",
        "rusCaps": "CapsLock",
        "engName": "CapsLock",
        "engShift": "CapsLock",
        "engCaps": "CapsLock"
    },
    {
        "id": 29,
        "code": "a",
        "key": "KeyA",
        "rusName": "ф",
        "rusShift": "Ф",
        "rusCaps": "Ф",
        "engName": "a",
        "engShift": "A",
        "engCaps": "A"
    },
    {
        "id": 30,
        "key": "KeyS",
        "rusName": "ы",
        "rusShift": "Ы",
        "rusCaps": "Ы",
        "engName": "s",
        "engShift": "S",
        "engCaps": "S"
    },
    {
        "id": 31,
        "key": "KeyD",
        "rusName": "в",
        "rusShift": "В",
        "rusCaps": "В",
        "engName": "d",
        "engShift": "D",
        "engCaps": "D"
    },
    {
        "id": 32,
        "key": "KeyF",
        "rusName": "а",
        "rusShift": "А",
        "rusCaps": "А",
        "engName": "f",
        "engShift": "F",
        "engCaps": "F"
    },
    {
        "id": 33,
        "key": "KeyG",
        "rusName": "п",
        "rusShift": "П",
        "rusCaps": "П",
        "engName": "g",
        "engShift": "G",
        "engCaps": "G"
    },
    {
        "id": 34,
        "key": "KeyH",
        "rusName": "р",
        "rusShift": "Р",
        "rusCaps": "Р",
        "engName": "h",
        "engShift": "H",
        "engCaps": "H"
    },
    {
        "id": 35,
        "key": "KeyJ",
        "rusName": "о",
        "rusShift": "О",
        "rusCaps": "О",
        "engName": "j",
        "engShift": "J",
        "engCaps": "J"
    },
    {
        "id": 36,
        "key": "KeyK",
        "rusName": "л",
        "rusShift": "Л",
        "rusCaps": "Л",
        "engName": "k",
        "engShift": "K",
        "engCaps": "K"
    },
    {
        "id": 37,
        "key": "KeyL",
        "rusName": "д",
        "rusShift": "Д",
        "rusCaps": "Д",
        "engName": "l",
        "engShift": "L",
        "engCaps": "L"
    },
    {
        "id": 38,
        "key": "Semicolon",
        "rusName": "ж",
        "rusShift": "Ж",
        "rusCaps": "Ж",
        "engName": ";",
        "engShift": ":",
        "engCaps": ":"
    },
    {
        "id": 39,
        "key": "Quote",
        "rusName": "э",
        "rusShift": "Э",
        "rusCaps": "Э",
        "engName": "'",
        "engShift": "\"",
        "engCaps": "\""
    },
    {
        "id": 40,
        "key": "Backslash",
        "rusName": "ё",
        "rusShift": "Ё",
        "rusCaps": "Ё",
        "engName": "\\",
        "engShift": "|",
        "engCaps": "|"
    },
    {
        "id": 41,
        "key": "Enter",
        "rusName": "Enter",
        "rusShift": "Enter",
        "rusCaps": "Enter",
        "engName": "Enter",
        "engShift": "Enter",
        "engCaps": "Enter"
    },
    {
        "id": 42,
        "key": "ShiftLeft",
        "rusName": "Shift",
        "rusShift": "Shift",
        "rusCaps": "Shift",
        "engName": "Shift",
        "engShift": "Shift",
        "engCaps": "Shift"
    },
    {
        "id": 43,
        "code": "z",
        "key": "KeyZ",
        "rusName": "я",
        "rusShift": "Я",
        "rusCaps": "Я",
        "engName": "z",
        "engShift": "Z",
        "engCaps": "Z"
    },
    {
        "id": 44,
        "key": "KeyX",
        "rusName": "ч",
        "rusShift": "Ч",
        "rusCaps": "Ч",
        "engName": "x",
        "engShift": "X",
        "engCaps": "X"
    },
    {
        "id": 45,
        "key": "KeyC",
        "rusName": "с",
        "rusShift": "С",
        "rusCaps": "С",
        "engName": "c",
        "engShift": "C",
        "engCaps": "C"
    },
    {
        "id": 46,
        "key": "KeyV",
        "rusName": "м",
        "rusShift": "М",
        "rusCaps": "М",
        "engName": "v",
        "engShift": "V",
        "engCaps": "V"
    },
    {
        "id": 47,
        "key": "KeyB",
        "rusName": "и",
        "rusShift": "И",
        "rusCaps": "И",
        "engName": "b",
        "engShift": "B",
        "engCaps": "B"
    },
    {
        "id": 48,
        "key": "KeyN",
        "rusName": "т",
        "rusShift": "Т",
        "rusCaps": "Т",
        "engName": "n",
        "engShift": "N",
        "engCaps": "N"
    },
    {
        "id": 49,
        "key": "KeyM",
        "rusName": "ь",
        "rusShift": "Ь",
        "rusCaps": "Ь",
        "engName": "m",
        "engShift": "M",
        "engCaps": "M"
    },
    {
        "id": 50,
        "key": "Comma",
        "rusName": "б",
        "rusShift": "Б",
        "rusCaps": "Б",
        "engName": ",",
        "engShift": "<",
        "engCaps": "<"
    },
    {
        "id": 51,
        "key": "Period",
        "rusName": "ю",
        "rusShift": "Ю",
        "rusCaps": "Ю",
        "engName": ".",
        "engShift": ">",
        "engCaps": ">"
    },
    {
        "id": 52,
        "key": "Slash",
        "rusName": "/",
        "rusShift": "?",
        "rusCaps": "?",
        "engName": "/",
        "engShift": "?",
        "engCaps": "?"
    },
    {
        "id": 53,
        "key": "ArrowUp",
        "rusName": "&#9650;",
        "rusShift": "&#9650;",
        "rusCaps": "&#9650;",
        "engName": "&#9650;",
        "engShift": "&#9650;",
        "engCaps": "&#9650;"
    },
    {
        "id": 54,
        "key": "ShiftRight",
        "rusName": "Shift",
        "rusShift": "Shift",
        "rusCaps": "Shift",
        "engName": "Shift",
        "engShift": "Shift",
        "engCaps": "Shift"
    },
    {
        "id": 55,
        "key": "ControlLeft",
        "rusName": "Ctrl",
        "rusShift": "Ctrl",
        "rusCaps": "Ctrl",
        "engName": "Ctrl",
        "engShift": "Ctrl",
        "engCaps": "Ctrl"
    },
    {
        "id": 56,
        "key": "AltLeft",
        "rusName": "Alt",
        "rusShift": "Alt",
        "rusCaps": "Alt",
        "engName": "Alt",
        "engShift": "Alt",
        "engCaps": "Alt"
    },
    {
        "id": 57,
        "key": "MetaLeft",
        "rusName": "Cmd",
        "rusShift": "Cmd",
        "rusCaps": "Cmd",
        "engName": "Cmd",
        "engShift": "Cmd",
        "engCaps": "Cmd"
    },
    {
        "id": 58,
        "key": "Space",
        "rusName": "&nbsp",
        "rusShift": "&nbsp",
        "rusCaps": "&nbsp",
        "engName": "&nbsp",
        "engShift": "&nbsp",
        "engCaps": "&nbsp"
    },
    {
        "id": 59,
        "key": "AltRight",
        "rusName": "Alt",
        "rusShift": "Alt",
        "rusCaps": "Alt",
        "engName": "Alt",
        "engShift": "Alt",
        "engCaps": "Alt"
    },
    {
        "id": 60,
        "key": "ArrowLeft",
        "rusName": "&#9668;",
        "rusShift": "&#9668;",
        "rusCaps": "&#9668;",
        "engName": "&#9668;",
        "engShift": "&#9668;",
        "engCaps": "&#9668;"
    },
    {
        "id": 61,
        "key": "ArrowDown",
        "rusName": "&#9660;",
        "rusShift": "&#9660;",
        "rusCaps": "&#9660;",
        "engName": "&#9660;",
        "engShift": "&#9660;",
        "engCaps": "&#9660;"
    },
    {
        "id": 62,
        "key": "ArrowRight",
        "rusName": "&#9658;",
        "rusShift": "&#9658;",
        "rusCaps": "&#9658;",
        "engName": "&#9658;",
        "engShift": "&#9658;",
        "engCaps": "&#9658;"
    },
    {
        "id": 63,
        "key": "MetaRight",
        "rusName": "Cmd",
        "rusShift": "Cmd",
        "rusCaps": "Cmd",
        "engName": "Cmd",
        "engShift": "Cmd",
        "engCaps": "Cmd"
    }
]


let lang = 'eng';
let layout = 'lowercase';
let arrChars = [];

function getLocalStorage() {
    if(localStorage.getItem('lang')) {
        lang = localStorage.getItem('lang');
    }
}

function setLocalStorage() {
    localStorage.setItem('lang', lang);
}
window.addEventListener('beforeunload', setLocalStorage)

window.addEventListener('load', () => {
    const textarea = document.querySelector('.textarea');
    getLocalStorage();
    const keyboardBlock = document.querySelector('.keyboard-block');
    showKeys(lang,'lowercase');
    let position;
    let btns;
    setClickOnBtn();
    setKeydown();
    setKeyup();

    function setClickOnBtn() {
      btns = document.querySelectorAll('.key'); 
      btns.forEach((item) => {
        item.addEventListener('click', (e) => {
            let actBtn = e.target;
            if ( actBtn.classList.contains('Backspace') ) {
                position = textarea.selectionStart;
                position = deleteAfter(position)
            } else
            if ( actBtn.classList.contains('Backslash') ) {
                position = textarea.selectionStart;
                deleteBefore(position)
            } else
            if ( actBtn.classList.contains('Enter') ) {
                position = textarea.selectionStart;
                position = addRow(position)
            } else
            if ( actBtn.classList.contains('Tab') ) {
                position = textarea.selectionStart;
                position = addTab(position)
            } else
            if ( actBtn.classList.contains('CapsLock') ) {
                changeOnCaps(actBtn);
            } else {
               printletter(actBtn); 
            }
            
            textarea.focus()
        }); 
    }) 
    }
    
    function showKeys(lang,layout) {
        keyboardBlock.innerHTML = '';
        if ( layout == 'lowercase') {
            if ( lang == 'rus' ) {
                keys.forEach((item) => {
                    const key = `<div class="key ${item.key}">
                        <span class="name ${item.key}">${item.rusName}</span>
                    </div>`;
                    keyboardBlock.insertAdjacentHTML('beforeend', key);
                })
            } 
            if ( lang == 'eng' ) {
                keys.forEach((item) => {
                    const key = `<div class="key ${item.key}">
                        <span class="name">${item.engName}</span>
                    </div>`;
                    keyboardBlock.insertAdjacentHTML('beforeend', key);
                })
            }
        }
        if (layout == 'uppercase' ) {
            if ( lang == 'rus' ) {
                keys.forEach((item) => {
                    const key = `<div class="key ${item.key}">
                        <span class="name">${item.rusCaps}</span>
                    </div>`;
                    keyboardBlock.insertAdjacentHTML('beforeend', key);
                })
            } 
            if ( lang == 'eng' ) {
                keys.forEach((item) => {
                    const key = `<div class="key ${item.key}">
                        <span class="name">${item.engCaps}</span>
                    </div>`;
                    keyboardBlock.insertAdjacentHTML('beforeend', key);
                })
            }
        }
       
    }

    function printletter(btn) {
        let key = btn.innerText.trim();
        let position = textarea.selectionStart;
        let arr = textarea.value.split('');
        let caps = document.querySelector('.CapsLock');
        let shiftLeft = document.querySelector('.ShiftLeft');
        let shiftRight = document.querySelector('.ShiftRight');
        if ( key == '◄' || key == '▲' || key == '▼' || key == '►' || key == 'Del' || key == '<-' || key == 'Tab' || key == 'CapsLock' || key == 'Shift' || key == 'ControlLeft' || key == 'AltLeft' || key == 'AltRight' || key == 'MetaRight' || key == 'MetaLeft' || key == 'ArrowLeft' || key == 'ArrowUp' || key == 'ArrowRight' || key == 'ArrowDown' || key == 'Enter' ) {
            return
        }
        if ( caps.classList.contains('clicked') ) {
            key = key.toUpperCase();
        } else if ( shiftLeft.classList.contains('clicked') || shiftRight.classList.contains('clicked') ) {
            key = key.toUpperCase();
        } else {
            key = key
        }

        if ( position < arr.length ) {
            arr = textarea.value.split('');
            const newValue = convertArrayToList(arr);
            let listArr = addToList(newValue, position, key);
            textarea.value = listArr.join('');
            textarea.selectionStart = position + 1;
        } else {
           textarea.value += key; 
        }

    }

    function setKeydown() {
        document.addEventListener('keydown',(e) => {
                let code = e.code;
                if ( code == 'Backslash') {
                    deleteBefore()
                }
                addChars(code);
                if ( code == 'ShiftLeft' || code == 'ShiftRight' || code == 'ControlLeft' || code == 'CapsLock') {
                    e.preventDefault();
                }
                if ( code == 'Tab') {
                    e.preventDefault();
                    position = textarea.selectionStart;
                    position = addTab(position);
                }
                if ( code == 'Space') {
                    e.preventDefault();
                    e.preventDefault();
                    position = textarea.selectionStart;
                    position = addSpace(position);
                }
                if ( code == 'CapsLock' ) {
                    e.preventDefault();
                    e.stopPropagation();
                    let key = document.querySelector(`.${code}`);
                    if ( key.classList.contains('clicked') ) {
                        layout = 'lowercase';
                        showKeys(lang,layout);
                        key.classList.remove('clicked')
                    } else {
                        layout = 'uppercase';
                        showKeys(lang,layout);
                        let caps = document.querySelector('.CapsLock');
                        caps.classList.add('clicked');
                    }
                    setClickOnBtn();
                    setKeydown();
                    setKeyup();
                } 
                keys.forEach((item) => {
                    if ( item.key == code ) {
                        let actKey = document.querySelector(`.${code}`);
                        actKey.classList.add('clicked');
                    }
                }) 
                
        })
    }

    function setKeyup() {
        btns = document.querySelectorAll('.key'); 
        document.addEventListener('keyup',(e) => {
        let actCode = e.key;
        if ( arrChars.includes('AltLeft') && arrChars.includes('ControlLeft') ) {
            changeLang();
            arrChars = [];
        } else {
            arrChars = [];
        }
        if ( actCode == actCode.toUpperCase() ) {
            btns.forEach((item) => {
                if ( item.classList.contains('ShiftLeft') || item.classList.contains('ShiftRight') || item.classList.contains('CapsLock') ) {
                } else {
                    if ( item.classList.contains('clicked') ) {
                        item.classList.remove('clicked')
                    }
                }
            })
        } else {
            let actKey = document.querySelector(`.${e.code}`);
            actKey.classList.remove('clicked');
        }
        })
    }
    count = 0;
    
    

    function addChars(code) {
        if ( code == 'ControlLeft' ) {
            arrChars.push(code);
        }
        if ( code == 'AltLeft' ) {
            if ( arrChars.includes('ControlLeft') ) {
                arrChars.push(code);
            }
        }
    }

    function changeLang() {
        if ( lang == 'rus' ) {
            lang = 'eng';
            showKeys(lang,layout);
            if ( layout == 'uppercase' ) {
                let caps = document.querySelector('.CapsLock');
                caps.classList.add('clicked');
            }
        } else {
            lang = 'rus';
            showKeys(lang,layout);
            if ( layout == 'uppercase' ) {
                let caps = document.querySelector('.CapsLock');
                caps.classList.add('clicked');
            }
        }
        setClickOnBtn();
        setKeydown();
        setKeyup();
    }

    function changeOnCaps(key) {
        let actKey = key;
        if ( actKey.classList.contains('clicked') ) {
            layout = 'lowercase';
            showKeys(lang,layout);
            actKey.classList.remove('clicked')
        } else {
            layout = 'uppercase';
            showKeys(lang,layout);
            let caps = document.querySelector('.CapsLock');
            caps.classList.add('clicked');
        }
        setClickOnBtn();
        setKeydown();
        setKeyup();
    }

    function deleteAfter(pos) {
        let position = pos;
        let textArr = textarea.value.split('');
        if (position <= 0) {
            return
        } else {
            textArr.splice(position-1,1);
            textarea.value = textArr.join('');
            textarea.selectionStart = position;  
        }
        return position
    }

    function deleteBefore(pos) {
        let position = pos;
        let textArr = textarea.value.split('');
        if (position >= textArr.length) {
            return
        } else
        if (pos == 0 ) {
            textArr.shift();
            textarea.value = textArr.join('');
            textarea.selectionStart = 0;
        } else {
            textArr.splice(position,1);
            textarea.value = textArr.join('');
            textarea.selectionStart = position;  
        }
        return position
    }

    function addRow(pos) {
        let position = pos;
        let value = '\n';
        let textArr = textarea.value.split('');
        let linkedList = convertArrayToList(textArr);
        let newArr = addToList(linkedList,position,value);
        textarea.value = newArr.join('');
    }

    function addTab(pos) {
        let position = pos;
        let value = '\t';
        let textArr = textarea.value.split('');
        let linkedList = convertArrayToList(textArr);
        let newArr = addToList(linkedList,position,value);
        textarea.value = newArr.join('');
    }

    function addSpace(pos) {
        let position = pos;
        let value = ' ';
        let textArr = textarea.value.split('');
        let linkedList = convertArrayToList(textArr);
        let newArr = addToList(linkedList,position,value);
        textarea.value = newArr.join('');
    }
    
})

    class ListNode {
        constructor(x) {
           this.value = x;
           this.next = null;
        }
    }

    function convertArrayToList(arr) {
        return arr.reverse().reduce((acc, cur) => {
          if (acc) {
            const node = new ListNode(cur);
            node.next = acc;
            return node;
          }
      
          return new ListNode(cur);
        }, null);
    }

    function addToList(linkedList,position,value) {
        console.log(linkedList)
        let list = linkedList;
        let node = new ListNode(value);
        let prev = null;
        let resultArr = [];
        let i = 0;

        let current = list;

        while ( i < position ) {
            prev = current;
            current = prev.next;
            i++
        }
        if ( prev == null) {
            node.next = current;
            list = node;
        } else {
            prev.next = node;
            node.next = current;
        }
        current = list;
        while ( current ) {
            resultArr.push(current.value);
            prev = current;
            current = prev.next;
        }
        return resultArr;
    }

    